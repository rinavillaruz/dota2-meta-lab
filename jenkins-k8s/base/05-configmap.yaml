apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-config
  namespace: jenkins
  labels:
    app: jenkins
data:
  # Jenkins Configuration as Code
  jenkins.yaml: |
    jenkins:
      systemMessage: "Jenkins for Dota2 Meta Lab CI/CD - Auto-deploy from GitHub"
      numExecutors: 2
      mode: NORMAL
      
      # Security configuration
      securityRealm:
        local:
          allowsSignup: false
          users:
            - id: "admin"
      
      authorizationStrategy:
        loggedInUsersCanDoAnything:
          allowAnonymousRead: false
    
    # Tool Configuration
    tool:
      git:
        installations:
          - name: "Default"
            home: "git"

    # Credentials
    credentials:
      system:
        domainCredentials:
          - credentials:
              # GitHub credentials
              - usernamePassword:
                  scope: GLOBAL
                  id: "github-credentials"
                  username: ${readFile:/run/secrets/github/username}
                  password: ${readFile:/run/secrets/github/token}
                  description: "GitHub credentials from secret"
              
              # Docker Hub credentials
              - usernamePassword:
                  scope: GLOBAL
                  id: "docker-hub-credentials"
                  username: ${readFile:/run/secrets/dockerhub/username}
                  password: ${readFile:/run/secrets/dockerhub/token}
                  description: "Docker Hub credentials from secret"

              # Docker registry URL (from env var, not secret file)
              - string:
                  scope: GLOBAL
                  id: "docker-registry-url"
                  secret: "docker.io"
                  description: "Docker registry URL"
              
              # Docker image prefix (from env var, not secret file)
              - string:
                  scope: GLOBAL
                  id: "docker-image-prefix"
                  secret: "rinavillaruz"
                  description: "Docker image prefix/username"
    
    # Jenkins URL configuration
    unclassified:
      location:
        url: http://localhost:30808/
    
    # Jobs Configuration
    jobs:
      # Single pipeline job for manual builds
      - script: >
          pipelineJob('dota2-meta-lab') {
            description('Manual deployment pipeline with parameters')
            definition {
              cpsScm {
                scm {
                  git {
                    remote {
                      url('https://github.com/rinavillaruz/dota2-meta-lab.git')
                      credentials('github-credentials')
                    }
                    branch('*/main')
                  }
                }
                scriptPath('ci/Jenkinsfile')
              }
            }
            parameters {
              choiceParam('ENVIRONMENT', ['dev', 'staging', 'production'], 'Which environment to deploy to?')
              booleanParam('RUN_TESTS', false, 'Run tests? (Adds ~3s)')
            }
            triggers {
              pollSCM {
                scmpoll_spec('H/5 * * * *')
              }
            }
          }
  
  # Plugins to auto-install
  plugins.txt: |
    # Core Authentication & Credentials
    credentials:latest
    credentials-binding:latest
    plain-credentials:latest
    
    # Git & GitHub Integration
    git:latest
    github:latest
    github-api:latest
    github-branch-source:latest
    scm-api:latest
    branch-api:latest
    
    # Pipeline Core Plugins
    workflow-aggregator:latest
    workflow-api:latest
    workflow-step-api:latest
    workflow-cps:latest
    workflow-job:latest
    workflow-support:latest
    workflow-durable-task-step:latest
    workflow-multibranch:latest
    pipeline-stage-view:latest
    pipeline-build-step:latest
    
    # Docker Integration
    docker-workflow:latest
    docker-commons:latest
    
    # Configuration as Code (JCasC)
    configuration-as-code:latest
    
    # Kubernetes Integration  
    kubernetes:latest
    
    # Job DSL
    job-dsl:latest
    
    # Slack Integration
    slack:latest
    
    # Useful Utilities
    timestamper:latest
    ws-cleanup:latest
    ansicolor:latest
    build-timeout:latest
    
    # HTTP Request (for Slack webhooks)
    http_request:latest