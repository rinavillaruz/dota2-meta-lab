apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-config
  namespace: jenkins
  labels:
    app: jenkins
data:
  # Jenkins Configuration as Code
  jenkins.yaml: |
    jenkins:
      systemMessage: "Jenkins for Dota2 Meta Lab CI/CD - Auto-deploy from GitHub"
      numExecutors: 2
      mode: NORMAL
      
      # Security configuration
      securityRealm:
        local:
          allowsSignup: false
          users:
            - id: "admin"
      
      authorizationStrategy:
        loggedInUsersCanDoAnything:
          allowAnonymousRead: false
    
    # Tool Configuration
    tool:
      git:
        installations:
          - name: "Default"
            home: "git"

    # Credentials
    credentials:
      system:
        domainCredentials:
          - credentials:
              # GitHub credentials
              - usernamePassword:
                  scope: GLOBAL
                  id: "github-credentials"
                  username: ${readFile:/run/secrets/github/username}
                  password: ${readFile:/run/secrets/github/token}
                  description: "GitHub credentials from secret"
              
              # Docker Hub credentials
              - usernamePassword:
                  scope: GLOBAL
                  id: "docker-hub-credentials"
                  username: ${readFile:/run/secrets/dockerhub/username}
                  password: ${readFile:/run/secrets/dockerhub/token}
                  description: "Docker Hub credentials from secret"

              # Docker registry URL
              - string:
                  scope: GLOBAL
                  id: "docker-registry-url"
                  secret: "docker.io"
                  description: "Docker registry URL"
              
              # Docker image prefix
              - string:
                  scope: GLOBAL
                  id: "docker-image-prefix"
                  secret: "rinavillaruz"
                  description: "Docker image prefix/username"
              
              # Slack webhook URL
              - string:
                  scope: GLOBAL
                  id: "slack-webhook-url"
                  secret: ${readFile:/run/secrets/slack/url}
                  description: "Slack webhook URL for notifications"
    
    # Jenkins URL configuration
    unclassified:
      location:
        url: http://localhost:30808/
      
      # Slack configuration
      slackNotifier:
        teamDomain: "your-workspace"
        tokenCredentialId: "slack-webhook-url"
        botUser: false
    
    # Jobs Configuration
    jobs:
      # Original single-branch pipeline (for manual builds)
      - script: >
          multibranchPipelineJob('dota2-meta-lab-auto') {
            branchSources {
              github {
                id('dota2-meta-lab')
                repoOwner('rinavillaruz')
                repository('dota2-meta-lab')
                credentialsId('github-credentials')
                traits {
                  gitHubBranchDiscovery {
                    strategyId(1)  // Discover all branches
                  }
                }
              }
            }
            orphanedItemStrategy {
              discardOldItems {
                numToKeep(10)
              }
            }
            triggers {
              periodicFolderTrigger {
                interval('1m')
              }
            }
          }
      
      # Multibranch pipeline (for auto-deployment)
      - script: >
          multibranchPipelineJob('dota2-meta-lab-auto') {
            description('Auto-deploy pipeline triggered by GitHub pushes')
            branchSources {
              github {
                id('dota2-meta-lab')
                repoOwner('rinavillaruz')
                repository('dota2-meta-lab')
                credentialsId('github-credentials')
                traits {
                  gitHubBranchDiscovery {
                    strategyId(1)
                  }
                  headWildcardFilter {
                    includes('main dev staging feature/*')
                    excludes('')
                  }
                }
              }
            }
            orphanedItemStrategy {
              discardOldItems {
                numToKeep(10)
              }
            }
            triggers {
              periodicFolderTrigger {
                interval('1m')
              }
            }
            factory {
              workflowBranchProjectFactory {
                scriptPath('ci/Jenkinsfile')
              }
            }
          }
  
  # Plugins to auto-install
  plugins.txt: |
    # Core Authentication & Credentials
    credentials:latest
    credentials-binding:latest
    plain-credentials:latest
    
    # Git & GitHub Integration
    git:latest
    github:latest
    github-api:latest
    github-branch-source:latest
    scm-api:latest
    branch-api:latest
    
    # Pipeline Core Plugins
    workflow-aggregator:latest
    workflow-api:latest
    workflow-step-api:latest
    workflow-cps:latest
    workflow-job:latest
    workflow-support:latest
    workflow-durable-task-step:latest
    workflow-multibranch:latest
    pipeline-stage-view:latest
    pipeline-build-step:latest
    
    # Docker Integration
    docker-workflow:latest
    docker-commons:latest
    
    # Configuration as Code (JCasC)
    configuration-as-code:latest
    
    # Kubernetes Integration  
    kubernetes:latest
    
    # Job DSL
    job-dsl:latest
    
    # Slack Integration
    slack:latest
    
    # Useful Utilities
    timestamper:latest
    ws-cleanup:latest
    ansicolor:latest
    build-timeout:latest
    
    # HTTP Request (for Slack webhooks)
    http_request:latest