apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-config
  namespace: jenkins
  labels:
    app: jenkins
data:
  # Jenkins Configuration as Code
  jenkins.yaml: |
    jenkins:
      systemMessage: "Jenkins for Dota2 Meta Lab CI/CD"
      numExecutors: 2
      mode: NORMAL
      
      # Security configuration
      securityRealm:
        local:
          allowsSignup: false
          users:
            - id: "admin"
      
      authorizationStrategy:
        loggedInUsersCanDoAnything:
          allowAnonymousRead: false
    
    # Tool Configuration
    tool:
      git:
        installations:
          - name: "Default"
            home: "git"

    # Credentials (will be added via Jenkins UI or JCasC)
    credentials:
      system:
        domainCredentials:
          - credentials:
              # GitHub credentials from Kubernetes secret
              - usernamePassword:
                  scope: GLOBAL
                  id: "github-credentials"
                  username: ${readFile:/run/secrets/github/username}
                  password: ${readFile:/run/secrets/github/token}
                  description: "GitHub credentials from secret"
              
              # Docker Hub credentials from Kubernetes secret
              - usernamePassword:
                  scope: GLOBAL
                  id: "docker-hub-credentials"
                  username: ${readFile:/run/secrets/dockerhub/username}
                  password: ${readFile:/run/secrets/dockerhub/token}
                  description: "Docker Hub credentials from secret"

              # Docker registry URL as string credential
              - string:
                  scope: GLOBAL
                  id: "docker-registry-url"
                  secret: "docker.io"
                  description: "Docker registry URL"
              
              # Docker image prefix as string credential
              - string:
                  scope: GLOBAL
                  id: "docker-image-prefix"
                  secret: "rinavillaruz"
                  description: "Docker image prefix/username"
    
    # Jenkins URL configuration
    unclassified:
      location:
        url: http://localhost:30808/
    
    # Pre-configured pipeline job
    jobs:
      - script: >
          pipelineJob('dota2-meta-lab') {
            definition {
              cpsScm {
                scm {
                  git {
                    remote {
                      url('https://github.com/rinavillaruz/dota2-meta-lab.git')
                      credentials('github-credentials')
                    }
                    branch('*/main')
                  }
                }
                scriptPath('ci/Jenkinsfile')
              }
            }
            triggers {
              pollSCM {
                scmpoll_spec('H/5 * * * *')
              }
            }
          }


  
  # Plugins to auto-install
  plugins.txt: |
    # Core Authentication & Credentials
    credentials
    credentials-binding
    plain-credentials
    
    # Git & GitHub Integration
    git
    github
    github-api
    github-branch-source
    scm-api
    branch-api
    
    # Pipeline Core Plugins
    workflow-aggregator
    workflow-api
    workflow-step-api
    workflow-cps
    workflow-job
    workflow-support
    workflow-durable-task-step
    pipeline-stage-view
    pipeline-build-step
    
    # Docker Integration
    docker-workflow
    docker-commons
    
    # Configuration as Code (JCasC)
    configuration-as-code
    
    # Kubernetes Integration  
    kubernetes
    
    # Job DSL
    job-dsl
    
    # Useful Utilities
    timestamper
    ws-cleanup
    ansicolor
    build-timeout