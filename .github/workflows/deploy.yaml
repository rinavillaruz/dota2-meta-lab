name: Deploy to Environment

on:
  push:
    branches:
      - main
      - dev
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Determine environment
        id: env
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          
          if [[ "$BRANCH" == "main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
          
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Deploying branch: $BRANCH to environment: ${{ steps.env.outputs.environment }}"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Generate image tag
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          IMAGE_TAG="${{ github.run_number }}-${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Generated image tag: ${IMAGE_TAG}"
      
      - name: Build and push data-fetcher
        uses: docker/build-push-action@v5
        with:
          context: ./services/data-fetcher
          file: ./services/data-fetcher/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/dota2-fetcher:${{ steps.meta.outputs.image_tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/dota2-fetcher:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push trainer
        uses: docker/build-push-action@v5
        with:
          context: ./services/ml-trainer
          file: ./services/ml-trainer/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/dota2-trainer:${{ steps.meta.outputs.image_tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/dota2-trainer:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: ./services/api
          file: ./services/api/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/dota2-api:${{ steps.meta.outputs.image_tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/dota2-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl config current-context
      
      - name: Deploy with Helm
        env:
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
          MONGODB_USERNAME: ${{ secrets.MONGODB_USERNAME }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
        run: |
          echo "Deploying to $ENVIRONMENT with image tag $IMAGE_TAG"
          
          # Make script executable
          chmod +x cli/deploy-with-helm.sh
          
          # Deploy using your script
          ./cli/deploy-with-helm.sh $ENVIRONMENT $IMAGE_TAG
      
      - name: Verify deployment
        run: |
          echo "Checking deployment status..."
          kubectl get pods -n data
          kubectl get svc -n data
          helm list -n data
      
      - name: Send Slack notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TEXT="✅ Deployment successful to ${{ steps.env.outputs.environment }}"
            COLOR="good"
          else
            TEXT="❌ Deployment failed to ${{ steps.env.outputs.environment }}"
            COLOR="danger"
          fi
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d @- <<EOF
          {
            "attachments": [{
              "color": "$COLOR",
              "title": "$TEXT",
              "fields": [
                {
                  "title": "Environment",
                  "value": "${{ steps.env.outputs.environment }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ steps.env.outputs.branch }}",
                  "short": true
                },
                {
                  "title": "Image Tag",
                  "value": "${{ steps.meta.outputs.image_tag }}",
                  "short": true
                },
                {
                  "title": "Author",
                  "value": "${{ github.actor }}",
                  "short": true
                },
                {
                  "title": "Commit",
                  "value": "${{ github.event.head_commit.message }}",
                  "short": false
                }
              ],
              "footer": "GitHub Actions",
              "ts": $(date +%s)
            }]
          }
          EOF