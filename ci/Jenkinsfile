pipeline {
    agent any
    
    environment {
        // Docker registry settings
        DOCKER_REGISTRY =   "docker.io"
        DOCKER_REPO     =   "rinavillaruz"
        
        // Git settings
        GIT_REPO        =   "https://github.com/rinavillaruz/dota2-meta-lab.git"
        
        // Kubernetes namespace
        K8S_NAMESPACE   =   "ml-pipeline"
        
        // ArgoCD app name
        ARGOCD_APP      =   "dota2-dev"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì¶ Checking out code...'
                checkout scm
            }
        }
        
        stage('Test') {
            steps {
                echo 'üß™ Running tests...'
                script {
                    sh '''
                        # Install dependencies
                        pip install -r build/requirements.txt || true
                        
                        # Run tests
                        python -m pytest tests/ || true
                        
                        # Lint code
                        flake8 src/ || true
                    '''
                }
            }
        }
        
        stage('Build Docker Images') {
            steps {
                echo 'üê≥ Building multi-stage Docker images...'
                script {
                    // Generate version tag
                    def imageTag = "${env.BUILD_NUMBER}-${env.GIT_COMMIT.take(7)}"
                    env.IMAGE_TAG = imageTag
                    
                    echo "Building images with tag: ${imageTag}"
                    
                    // Build Data Fetcher
                    echo "üì¶ Building Data Fetcher..."
                    sh """
                        docker build \
                          --target data-fetcher \
                          -f build/Dockerfile.dev \
                          -t ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-fetcher:${imageTag} \
                          -t ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-fetcher:latest \
                          .
                    """
                    
                    // Build Trainer
                    echo "üì¶ Building Trainer..."
                    sh """
                        docker build \
                          --target trainer \
                          -f build/Dockerfile.dev \
                          -t ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-trainer:${imageTag} \
                          -t ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-trainer:latest \
                          .
                    """
                    
                    // Build API
                    echo "üì¶ Building API Server..."
                    sh """
                        docker build \
                          --target api \
                          -f build/Dockerfile.dev \
                          -t ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-api:${imageTag} \
                          -t ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-api:latest \
                          .
                    """
                }
            }
        }
        
        stage('Push Docker Images') {
            steps {
                echo 'üì§ Pushing Docker images to registry...'
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin ${DOCKER_REGISTRY}
                            
                            # Push Data Fetcher
                            docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-fetcher:${env.IMAGE_TAG}
                            docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-fetcher:latest
                            
                            # Push Trainer
                            docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-trainer:${env.IMAGE_TAG}
                            docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-trainer:latest
                            
                            # Push API
                            docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-api:${env.IMAGE_TAG}
                            docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-api:latest
                        """
                    }
                }
            }
        }
        
        stage('Update Helm Values') {
            steps {
                echo 'üìù Updating Helm values with new image tags...'
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'github-credentials',
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_TOKEN'
                    )]) {
                        sh """
                            # Configure Git
                            git config user.email "jenkins@dota2-meta-lab.local"
                            git config user.name "Jenkins CI"
                            
                            # Update image tags in Helm values
                            # Update for API
                            sed -i 's|repository: .*/dota2-api|repository: ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-api|g' deploy/helm/values.yaml
                            sed -i 's|tag: .*|tag: "${env.IMAGE_TAG}"|g' deploy/helm/values.yaml
                            
                            # Commit and push
                            git add deploy/helm/values.yaml
                            git commit -m "ci: update image tags to ${env.IMAGE_TAG}" || true
                            git push https://${GIT_TOKEN}@github.com/rinavillaruz/dota2-meta-lab.git HEAD:main
                        """
                    }
                }
            }
        }
        
        stage('Trigger ArgoCD Sync') {
            steps {
                echo 'üîÑ Triggering ArgoCD sync...'
                script {
                    sh """
                        argocd app sync ${ARGOCD_APP} --insecure || echo "ArgoCD auto-sync will handle deployment"
                    """
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo '‚úÖ Verifying deployment...'
                script {
                    sh """
                        # Check pods in ml-pipeline namespace
                        kubectl get pods -n ${K8S_NAMESPACE} || true
                        
                        # Wait for API deployment if it exists
                        kubectl rollout status deployment/ml-api -n ${K8S_NAMESPACE} --timeout=300s || true
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline completed successfully!'
            echo "üöÄ Images built and pushed:"
            echo "   - Fetcher: ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-fetcher:${env.IMAGE_TAG}"
            echo "   - Trainer: ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-trainer:${env.IMAGE_TAG}"
            echo "   - API: ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-api:${env.IMAGE_TAG}"
        }
        failure {
            echo '‚ùå Pipeline failed!'
        }
        always {
            echo 'üßπ Cleaning up...'
            sh """
                docker rmi ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-fetcher:${env.IMAGE_TAG} || true
                docker rmi ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-fetcher:latest || true
                docker rmi ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-trainer:${env.IMAGE_TAG} || true
                docker rmi ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-trainer:latest || true
                docker rmi ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-api:${env.IMAGE_TAG} || true
                docker rmi ${DOCKER_REGISTRY}/${DOCKER_REPO}/dota2-api:latest || true
            """
        }
    }
}