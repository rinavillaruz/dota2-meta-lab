{{- if .Values.mlTrainer.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.mlTrainer.name }}-{{ now | date "20060102-150405" }}
  namespace: {{ .Values.global.namespace }}
  labels:
    app: {{ .Values.mlTrainer.name }}
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: trainer
          image: {{ .Values.image.registry }}/{{ .Values.image.repository }}/{{ .Values.mlTrainer.name }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["python", "/app/scripts/train_model.py"]
          resources:
            {{- toYaml .Values.mlTrainer.resources | nindent 12 }}
          {{- if .Values.mlTrainer.persistence.enabled }}
          volumeMounts:
            - name: training-data
              mountPath: /data/ml-training
              readOnly: true
            - name: models
              mountPath: /models
          {{- end }}
      {{- if .Values.mlTrainer.persistence.enabled }}
      volumes:
        - name: training-data
          persistentVolumeClaim:
            claimName: {{ .Values.mlTrainer.name }}-training-data  # ← Use template variable
        - name: models
          persistentVolumeClaim:
            claimName: {{ .Values.mlTrainer.name }}-models  # ← Use template variable
      {{- end }}
{{- end }}